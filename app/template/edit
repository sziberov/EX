<?
	try {
		$object = new Object_($path[1] ?? null);
	} catch(Exception $e) {
		$error = D['error_page_not_found'];
		http_response_code(404);
		return include 'error';
	}

	if($object->type_id != 4) {
		if(!session()) {
			return include 'login';
		}

		$user = new Object_(session_getUserID());
	}

	$allow_advanced_control = session_getSettings()['allow_advanced_control'] ?? false;

	if($object->access_level_id < 4 || $object->type_id == 2 && !$allow_advanced_control) {
		$error = D['error_page_forbidden'];
	//	$error = 'Доступ ограничен из-за несоблюдения правил использования сервиса.';
		http_response_code(403);
		return include 'error';
	}

	$hide_default_referrer = filter_var($object->settings['hide_default_referrer']->value ?? null, FILTER_VALIDATE_BOOLEAN);

	try {
		$referrer = new Object_(object_getValidReferrerID($object->id, $_GET['referrer_id'] ?? null, !$hide_default_referrer));
	} catch(Exception $e) {}

	$referred_title = $object->title.(!empty($referrer) ? ' - '.$referrer->title : '');
?>
<title><?= dictionary_getPageTitle($referred_title.' - '.D['title_edit']); ?></title>
<? if(!empty($referrer)) { ?>
	<div _flex="h wrap" _title="small">
		<!--
		<div fallback_>Создание статьи на странице пользователя</div>
		<div fallback_>Создание аватара</div>
		<div fallback_>Создание группы доступа</div>
		<div fallback_>Включение в раздел</div>
		<div fallback_>Комментарий к</div>
		-->
		<a href="/<?= $referrer->id; ?>"><?= $referrer->title; ?></a>
	</div>
<? } ?>
<div _table style="--columns: minmax(96px, max-content) minmax(96px, auto) minmax(96px, max-content);">
	<div>
		<div></div>
		<div _title centered_><?= D['title_edit']; ?></div>
		<div></div>
	</div>
	<? if($object->type_id == 4) { ?>
		<div>
			<div>Ключ доступа</div>
			<div _flex="v stacked left">
				<div>Номер <b><?= $object->id; ?></b> или ссылка <b><?= DOMAIN_ROOT.'/'.$object->id; ?></b></div>
				<div fallback_>Сохраните эти данные, доступ к объекту возможен только по ним</div>
			</div>
			<div></div>
		</div>
	<? } ?>
	<div>
		<div><?= D['string_title']; ?></div>
		<div>
			<input size_="max" name="title" type="text" value="<?= $object->title; ?>">
		</div>
		<div></div>
	</div>
	<div>
		<div><?= D['string_description']; ?></div>
		<div _flex="v left">
			<textarea size_="max" name="description"><?= $object->description; ?></textarea>
			<div _flex="h wrap">
				<button data-bb-code="b"><b><?= D['button_bold']; ?></b></button>
				<button data-bb-code="i"><i><?= D['button_italic']; ?></i></button>
				<button data-bb-code="u"><u><?= D['button_underscored']; ?></u></button>
				<button data-bb-code="s"><s><?= D['button_striked']; ?></s></button>
				<button data-bb-code="sup"><sup><?= D['button_super']; ?></sup></button>
				<button data-bb-code="sub"><sub><?= D['button_sub']; ?></sub></button>
				<button data-bb-code="url"><?= D['button_link']; ?></button>
				<button data-bb-code="color"><?= D['button_color']; ?></button>
				<button data-bb-code="lang"><?= D['button_language']; ?></button>
				<button data-bb-code="left">←</button>
				<button data-bb-code="center">|</button>
				<button data-bb-code="right">→</button>
				<button data-bb-code="just">↔</button>
			</div>
		</div>
		<div></div>
	</div>
	<? if($object->type_id != 4) { ?>
		<div>
			<div><?= D['string_avatar']; ?></div>
			<div>
				<? if($user->avatars_count > 0) { ?>
					<select>
						<option><?= $object->type_id != 2 ? 'По умолчанию' : 'Нет' ; ?></option>
						<option>DIES</option>
					</select>
					<a _avatar href="/user/_USER_TITLE_" title="DIES">
						<img src="/app/image/background.png">
					</a>
				<? } else { ?>
					<div>Для выбора аватара его необходимо создать <a href="/avatars">здесь</a></div>
				<? } ?>
			</div>
			<div></div>
		</div>
	<? }
	if($object->type_id != 4 && $object->access_level_id == 5 || (session_getSettings()['allow_advanced_control'] ?? false)) { ?>
		<div>
			<div>Доступ для "Всех"</div>
			<div>
				<select name="everyone_access_level_id">
					<?
						$everyone_access_level_id = 0;

						foreach($object->group_object_access_links as $goa_link) {
							if($goa_link->from_id == 1) {
								$everyone_access_level_id = $goa_link->settings['access_level_id']->value ?? 0;

								break;
							}
						}

						for($i = 0; $i < 6; $i++) { ?>
							<option value="<?= $i; ?>" <?= $i == $everyone_access_level_id ? 'selected' : ''; ?>><?= D['string_access_level_'.$i]; ?></option>
						<? }
					?>
				</select>
			</div>
			<div></div>
		</div>
	<? } ?>
	<div>
		<div></div>
		<div>
			<a _button href="/view/<?= $object->id; ?>"><?= D['button_view']; ?></a>
			<button onclick="Request.save('<?= $object->id; ?>')"><?= D['button_save']; ?></button>
			<? if($object->type_id != 4 && $object->access_level_id == 5) { ?>
				<button onclick="Request.delete('<?= $object->id; ?>')"><?= D['button_delete']; ?></button>
			<? } ?>
			<? if($object->type_id != 4) { ?>
				<a _button href="/edit_settings/<?= $object->id; ?>"><?= D['button_settings']; ?></a>
			<? } ?>
			<? if($object->type_id != 4 && $object->access_level_id == 5) { ?>
				<a _button href="/edit_access/<?= $object->id; ?>"><?= D['button_access']; ?></a>
			<? } ?>
		</div>
		<div></div>
	</div>
</div>
<? include 'edit.lists'; ?>
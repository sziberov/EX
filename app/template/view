<?
	$object_id = $page == 'view' ? $path[1] ?? null : ($page == 'user' ? object_getUserID($path[1]) : $path[0]);

	try {
		$object = new Object_($object_id);
	} catch(Exception $e) {
		$error = D['error_page_not_found'];
		http_response_code(404);
		return include 'error';
	}

	if($object->access_level_id == 0) {
		$error = D['error_page_forbidden'];
		http_response_code(403);
		return include 'error';
	}

	object_createVisitID($object->id);

	$display_mode_id = $_GET['display_mode_id'] ?? filter_var($object->settings['display_mode_id']->value ?? null, FILTER_VALIDATE_INT) ?? 0;
	$sort_mode_id = $_GET['sort_mode_id'] ?? 0;

	if($object->type_id == 3) {
		$hide_default_referrer = filter_var($object->settings['hide_default_referrer']->value ?? null, FILTER_VALIDATE_BOOLEAN);

		try {
			$referrer = new Object_(object_getValidReferrerID($object->id, $_GET['referrer_id'] ?? null, !$hide_default_referrer));
		} catch(Exception $e) {}

		$referred_title = $object->title.(!empty($referrer) ? ' - '.$referrer->title : '');
	} else {
		$referred_title = $object->title;
	}

	$page_title = $object->type_id == 1 ? D['title_group'].' '.$object->title :
				 ($object->type_id == 2 ? D['title_user'].' '.$object->title :
				 ($object->type_id == 3 ? $referred_title :
										  $object->title));
?>
<title><?= dictionary_getPageTitle($page_title); ?></title>
<?
	$template = new Template('referrer');
	$template->object = $object;
	$template->referrer = $referrer ?? null;
	$template->display_mode_id = 1;
	$template->render(true);

	$awaiting_save = filter_var($object->settings['awaiting_save']->value ?? null, FILTER_VALIDATE_BOOLEAN);

	if($awaiting_save) { ?>
		<div _title="small" fallback_>Черновик</div>
	<? }

	include 'view.post';
?>
<? if($object->type_id == 2) {
	if(count($friends) > 0) { ?>
		<div _grid="v stacked">
			<b><?= $login != $session_login ? D['link_friends'] : '<a href="/friends">'.D['link_friends'].'</a>'; ?></b>
			<div _flex="h wrap">
				<? foreach($friends as $friend) {
					$template = new Template('user');
					$template->object = $friend;
					$template->mutual = object_areMutualFriends($object->id, $friend->id);
					$template->time_display_mode_id = 0;
					$template->render(true);
				} ?>
			</div>
		</div>
	<? }
	if($login == $session_login && count($notifications) > 0) { ?>
		<div _grid="v stacked">
			<b><a href="/notifications"><?= D['link_notifications']; ?></a></b>
			<div _grid="h">
				<div><?= D['string_groups_invites_count']; ?><div _badge>1</div></div>
				<div><?= D['string_friends_count']; ?><div _badge>1</div></div>
				<div><?= D['string_private_messages_count']; ?><div _badge>1</div></div>
				<div><?= D['string_comments_count']; ?><div _badge>1</div></div>
				<div><?= D['string_recommendations_count']; ?><div _badge>1</div></div>
			</div>
		</div>
	<? }
} else
if($object->inclusions_count > 0) { ?>
	<div _grid="h">
		<form _grid="h">
			<select name="display_mode_id" onchange="this.form.submit();">
				<?
					$dmid_options = ['cells', 'list'];

					foreach($dmid_options as $k => $dmid_option) { ?>
						<option value="<?= $k; ?>" <?= $k == $display_mode_id ? 'selected' : ''; ?>><?= D['string_as_'.$dmid_option]; ?></option>
					<? }
				?>
			</select>
			<select name="sort_mode_id" onchange="this.form.submit();">
				<?
					$smid_options = [
						'inclusion_time',
						'edit_time',
						'creation_time',
						'popularity',
						'visits',
						'comments',
						'recommendations',
						'title'
					];

					foreach($smid_options as $k => $smid_option) { ?>
						<option value="<?= $k; ?>" <?= $k == $sort_mode_id ? 'selected' : ''; ?>><?= D['string_by_'.$smid_option]; ?></option>
					<? }
				?>
			</select>
		</form>
		<form _grid="h" action="/search">
			<input size_="medium" name="query" type="text">
			<input name="section_id" type="hidden" value="<?= $object->id; ?>">
			<button type="submit"><?= D['button_search']; ?></button>
		</form>
	</div>
<? }

	$template = new Template('entities');

	if($object->type_id != 2) {
		$template->navigation_mode_id = 1;
		$template->navigation_page = $navigation_page;
		$template->navigation_items_per_page = $navigation_items_per_page;
		$template->navigation_rss_id = $object->id;
		$template->template_title = $display_mode_id == 0 ? 'objects-cells' : 'objects-list';
		$template->template_namespace = [
			'referrer_id' => $object->id
		];
	}

	$template->search_condition = "JOIN links AS l ON l.from_id = o.id AND l.to_id = $object->id AND l.type_id = 4";
	$template->render(true);

	include 'view.lists';
	include 'actions';
?>